name: è°æ˜¯å§åº•æ¸¸æˆ CI/CD éƒ¨ç½²æµæ°´çº¿

on:
  # è§¦å‘æ–¹å¼
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push: # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
    branches:
      - 'main'

env:
  TZ: Asia/Shanghai # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº

jobs:
  deploy:
    runs-on: ubuntu-latest # ä½¿ç”¨Ubuntuæœ€æ–°ç‰ˆæœ¬ä½œä¸ºè¿è¡Œç¯å¢ƒ
    environment: production # ä½¿ç”¨productionç¯å¢ƒ
    
    steps:
      - name: Deploy to target server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd ~/WebstormProjects/undercover || { echo "Project directory not found"; exit 1; }
            git pull # æ‹‰å–æœ€æ–°ä»£ç 

            # åœæ­¢å¹¶ç§»é™¤æ—§çš„å®¹å™¨
            docker compose down || true
            
            # å¯åŠ¨æ–°çš„å®¹å™¨
            docker compose up -d --build
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            docker image prune -f
            
            echo "Deployment completed successfully!"

      # å‘é€éƒ¨ç½²æˆåŠŸé‚®ä»¶é€šçŸ¥
      - name: Send deployment success email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ğŸš€ åº”ç”¨éƒ¨ç½²å®Œæˆ - ${{ github.repository }}"
          to: xing.xiaolin@foxmail.com
          from: GitHub Actions
          html_body: |
            <h2>ã€Šè°æ˜¯å§åº•ã€‹å¾®ä¿¡å…¬ä¼—å·å‘ç‰Œå™¨ï¼Œå·²éƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨</h2>
            <hr>
            <p><small>æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€</small></p>
